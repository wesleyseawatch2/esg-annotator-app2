# 重標註一致性分數更新測試指南

## 修改內容總結

本次修改解決了「儲存次數、承諾狀態、驗證時間、證據狀態、證據品質都沒有變動」的問題。

### 主要修改：

1. **`/api/reannotation/submit`** - 重標註時增加 `save_count`
2. **`/app/reannotation/[taskId]/page.js`** - 送出後等待一致性計算完成
3. **`/app/page.js`** - 頁面顯示時自動重新載入一致性分數
4. **`/app/reannotation/page.js`** - 頁面顯示時自動重新載入任務列表

## 測試步驟

### 測試 1：驗證儲存次數會增加

1. 完成一個專案的所有標註
2. 在主頁面查看重標註列表（應該會顯示一致性分數表格）
3. 找到一筆「儲存次數」為 0 的資料
4. 點擊「重新標註」按鈕，進入重標註頁面
5. 修改任何一個答案（例如承諾狀態從 Yes 改成 No）
6. 點擊「✓ 送出重標註」
7. **預期結果**：
   - 按鈕顯示「送出中...」
   - 瀏覽器 Console 會顯示「📊 正在重新計算一致性分數...」
   - 顯示「✅ 重標註已成功送出！一致性分數已更新。」
   - 返回列表後，該筆資料的「儲存次數」應該從 0 變成 1

### 測試 2：驗證一致性分數會變動

**情境 A：修改答案導致不一致**

假設初始狀態：
- 使用者 A: 承諾狀態 = Yes
- 使用者 B: 承諾狀態 = Yes
- 使用者 C: 承諾狀態 = Yes
- **一致性分數 = 1.00**（完全一致）

1. 使用者 A 重標註，將承諾狀態改成 No
2. 送出重標註
3. **預期結果**：
   - A 的標註變成：No, B 的標註：Yes, C 的標註：Yes
   - **一致性分數應該變成 0.33**（三人中只有 BC 一致）

**情境 B：修改答案回到一致**

假設初始狀態：
- 使用者 A: 承諾狀態 = No
- 使用者 B: 承諾狀態 = Yes
- 使用者 C: 承諾狀態 = Yes
- **一致性分數 = 0.33**

1. 使用者 A 重標註，將承諾狀態改成 Yes
2. 送出重標註
3. **預期結果**：
   - A, B, C 的標註都變成 Yes
   - **一致性分數應該變成 1.00**（完全一致）

### 測試 3：驗證頁面自動重新載入

**測試 3A：從重標註詳細頁面返回列表**

1. 在重標註詳細頁面完成修改並送出
2. 系統自動返回重標註列表頁面
3. **預期結果**：列表會顯示最新的一致性分數和儲存次數

**測試 3B：從其他頁面切換回主頁面**

1. 在主頁面查看重標註列表
2. 切換到另一個瀏覽器分頁或視窗
3. 使用另一台電腦/帳號進行重標註（或者在資料庫直接修改）
4. 切換回主頁面的分頁
5. **預期結果**：一致性分數應該會自動重新載入（因為 visibilitychange 事件）

### 測試 4：驗證主頁面重標註介面

1. 在主頁面的重標註介面直接修改答案
2. 點擊「儲存並下一筆」
3. **預期結果**：
   - 一致性分數會立即更新
   - 儲存次數會增加

## 檢查清單

- [ ] 重標註後「儲存次數」有增加
- [ ] 修改答案後「承諾狀態」分數有變動
- [ ] 修改答案後「驗證時間」分數有變動
- [ ] 修改答案後「證據狀態」分數有變動
- [ ] 修改答案後「證據品質」分數有變動
- [ ] 送出按鈕顯示「送出中...」
- [ ] Console 顯示「正在重新計算一致性分數」
- [ ] 返回列表後分數已更新（不需要手動重新整理頁面）
- [ ] 從其他頁面切換回來時分數會自動更新

## 常見問題排查

### 問題：儲存次數沒有增加

**可能原因**：
- `/api/reannotation/submit` 沒有正確更新 `save_count`

**檢查方法**：
1. 打開瀏覽器開發者工具 → Network
2. 重標註並送出
3. 檢查 `/api/reannotation/submit` 的回應
4. 直接查詢資料庫：
   ```sql
   SELECT user_id, source_data_id, save_count, version, reannotation_round
   FROM annotations
   WHERE source_data_id = [你的資料ID]
   ORDER BY version DESC
   LIMIT 5;
   ```

### 問題：一致性分數沒有變動

**可能原因 1**：修改的答案和其他人一樣

- 例如：A, B, C 都是 Yes，A 重標註後還是 Yes
- 分數不會變動因為答案沒有實質改變

**可能原因 2**：`/api/consistency` 沒有取得最新資料

**檢查方法**：
1. 打開瀏覽器開發者工具 → Console
2. 重標註並送出
3. 檢查是否有顯示「📊 正在重新計算一致性分數...」
4. 檢查是否有顯示「✓ 一致性分數已更新」
5. 如果有錯誤訊息，查看 Console 的詳細錯誤

**可能原因 3**：資料庫查詢沒有取得最新的 reannotation_round

**檢查方法**：
```sql
-- 檢查查詢邏輯
WITH LatestAnnotations AS (
    SELECT DISTINCT ON (a.source_data_id, a.user_id)
        a.source_data_id,
        a.user_id,
        a.promise_status,
        a.reannotation_round,
        a.version,
        a.save_count
    FROM annotations a
    JOIN source_data sd ON a.source_data_id = sd.id
    WHERE sd.project_id = [你的專案ID]
        AND a.source_data_id = [你的資料ID]
    ORDER BY a.source_data_id, a.user_id, a.reannotation_round DESC, a.version DESC, a.created_at DESC
)
SELECT * FROM LatestAnnotations;
```

應該看到每個 user_id 只有一筆資料，且是最新的 reannotation_round。

### 問題：頁面沒有自動重新載入

**可能原因**：瀏覽器不支援 visibilitychange 事件

**檢查方法**：
1. 手動重新整理頁面（F5）
2. 檢查一致性分數是否更新
3. 如果手動重新整理後有更新，表示只是自動重新載入功能有問題

**解決方法**：
- 確保使用現代瀏覽器（Chrome, Firefox, Edge）
- 或者手動重新整理頁面

## 效能考量

如果專案資料很多（例如 > 1000 筆），`/api/consistency` 計算可能需要幾秒鐘。在這種情況下：

1. 送出按鈕會持續顯示「送出中...」
2. 使用者需要等待計算完成
3. 這是正常行為，確保分數完全更新後才返回列表

如果計算時間過長（> 10 秒），可以考慮：
- 只計算當前使用者標註過的資料（已實作）
- 使用快取機制（已實作，但重標註後會清除快取）

## 程式碼變更驗證

執行以下指令驗證所有程式碼修改都已正確應用：

```bash
node scripts/verify-code-changes.js
```

應該顯示所有檢查都通過（✓）。
