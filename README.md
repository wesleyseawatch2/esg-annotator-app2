# ESG Annotator App (AI CUP è³‡æ–™æ¨™è¨»ç³»çµ±)

é€™æ˜¯ä¸€å€‹åŸºæ–¼ Next.js 15 çš„å…¨ç«¯è³‡æ–™æ¨™è¨»å¹³å°ï¼Œå°ˆç‚º ESG å ±å‘Šçš„æ‰¿è«¾èˆ‡é©—è­‰æ¨™è¨»è¨­è¨ˆã€‚ç³»çµ±æ•´åˆäº† PDF ç€è¦½ã€æ¨™è¨»å·¥å…·ã€å¾Œç«¯è³‡æ–™åº«ç®¡ç†ä»¥åŠç®¡ç†å“¡å¾Œå°åŠŸèƒ½ã€‚

---

## ğŸ›  æŠ€è¡“æ£§ (Tech Stack)

- **Framework**: [Next.js 15 (App Router)](https://nextjs.org/)
- **UI Library**: React 19
- **Database**: Vercel Postgres (SQL)
- **Storage**: Vercel Blob (PDF æª”æ¡ˆå„²å­˜)
- **PDF Engine**:
  - Viewer: `pdfjs-dist`
  - Manipulation: `pdf-lib` (ç”¨æ–¼è‡ªå‹•åˆ†é è™•ç†)
- **Deployment**: Vercel

---

## âœ¨ ä¸»è¦åŠŸèƒ½

### ğŸ§‘â€ğŸ’» æ¨™è¨»è€…ç«¯ (User)
- **PDF ç€è¦½å™¨**: æ”¯æ´ç¸®æ”¾ã€æ›é ã€Canvas æ¸²æŸ“ã€‚
- **æ¨™è¨»å·¥å…·**:
  - æ‰¿è«¾ (Promise) èˆ‡ è­‰æ“š (Evidence) æ¨™è¨˜ã€‚
  - æ”¯æ´ç•«æ¡† (Bounding Box) å®šä½ã€‚
  - ESG é¡åˆ¥åˆ†é¡ (E/S/G)ã€‚
- **é€²åº¦è¿½è¹¤**: æŸ¥çœ‹å€‹äººæ¨™è¨»é€²åº¦èˆ‡è·³éåŠŸèƒ½ã€‚

### ğŸ‘®â€â™‚ï¸ ç®¡ç†å“¡å¾Œå° (Admin)
- **å°ˆæ¡ˆç®¡ç†**:
  - æ”¯æ´å–®ä¸€å°ˆæ¡ˆä¸Šå‚³ã€‚
  - **æ‰¹æ¬¡ä¸Šå‚³**: æ”¯æ´å¤šå±¤è³‡æ–™å¤¾çµæ§‹ï¼Œè‡ªå‹•å°‡ PDF åˆ†å‰²ç‚ºå–®é ä¸¦å»ºç«‹å°æ‡‰å°ˆæ¡ˆã€‚
  - PDF é ç¢¼å°é½Šå·¥å…·ã€‚
- **è³‡æ–™åˆ†é…ç®¡ç†**:
  - å…¬å¸è³‡æ–™æƒæèˆ‡å»ºç«‹ã€‚
  - éˆæ´»åˆ†é…è³‡æ–™ç¯„åœçµ¦ä¸åŒå°ˆæ¡ˆ (Range Assignment)ã€‚
- **ç¾¤çµ„èˆ‡æ¬Šé™**: å»ºç«‹å°ˆæ¡ˆç¾¤çµ„ã€åˆ†é…ä½¿ç”¨è€…æ¬Šé™ã€‚
- **å…¬å‘Šç³»çµ±**: ç™¼å¸ƒç³»çµ±å…¬å‘Šï¼ˆæ”¯æ´é¡å‹èˆ‡ç‹€æ…‹åˆ‡æ›ï¼‰ã€‚
- **è³‡æ–™åŒ¯å‡º**: åŒ¯å‡ºæ¨™è¨»çµæœç‚º CSVã€‚
- **ä¸€è‡´æ€§åˆ†æ**: è¨ˆç®— Krippendorff's Alphaï¼Œæ‰¾å‡ºçˆ­è­°æ¡ˆä¾‹ã€‚
- **ğŸ”„ é‡æ¨™è¨»ç®¡ç†**: é‡å°ä¸€è‡´æ€§ä½çš„è³‡æ–™å»ºç«‹é‡æ¨™è¨»ä»»å‹™ã€‚

---

## ğŸš€ å¿«é€Ÿé–‹å§‹ (Getting Started)

### 1. å®‰è£ä¾è³´
```bash
npm install
```

### 2. è¨­å®šç’°å¢ƒè®Šæ•¸
è«‹åœ¨æ ¹ç›®éŒ„å»ºç«‹ .env.local æª”æ¡ˆï¼Œä¸¦å¡«å…¥ä»¥ä¸‹ Vercel ç›¸é—œè¨­å®šï¼š
```bash
POSTGRES_URL="postgres://..."
POSTGRES_PRISMA_URL="postgres://..."
POSTGRES_URL_NO_SSL="postgres://..."
POSTGRES_USER="..."
POSTGRES_HOST="..."
POSTGRES_PASSWORD="..."
POSTGRES_DATABASE="..."
BLOB_READ_WRITE_TOKEN="vercel_blob_rw_..."
```

### 3. è³‡æ–™åº«åˆå§‹åŒ– (Migrations)
å¦‚æœæ˜¯é¦–æ¬¡åŸ·è¡Œï¼Œè«‹åŸ·è¡Œä»¥ä¸‹è…³æœ¬ä»¥å»ºç«‹å¿…è¦çš„è³‡æ–™è¡¨çµæ§‹ï¼š
```bash
# å»ºç«‹ skipped æ¬„ä½
npm run migrate:skipped

# å»ºç«‹é‡æ¨™è¨»åŠŸèƒ½è³‡æ–™è¡¨ï¼ˆå¿…è¦ï¼‰
npm run migrate:reannotation

# ä¿®å¾©é‡æ¨™è¨»å”¯ä¸€æ€§ç´„æŸï¼ˆæ”¯æ´ç‰ˆæœ¬æ§åˆ¶ï¼‰â­ NEW
npm run migrate:fix-unique-constraint

# å…¶ä»– SQL åˆå§‹åŒ–è«‹åƒè€ƒ docs/ è³‡æ–™å¤¾ä¸‹çš„ sql æª”æ¡ˆ
```

### 4. å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
```bash
npm run dev
```
æ‰“é–‹ç€è¦½å™¨å‰å¾€ http://localhost:3000ã€‚
æˆ–è€…ï¼Œç›´æ¥å‰å¾€ï¼šhttps://www.aicup-ntpu-esg-annotation-web.space/

---

## ğŸ“Š è³‡æ–™åº«æ¶æ§‹ (Database Schema)

ç³»çµ±å…±æœ‰ **13 å¼µè³‡æ–™è¡¨**ï¼Œåˆ†ç‚º 4 å€‹ä¸»è¦é¡åˆ¥ï¼š

### æ ¸å¿ƒè³‡æ–™è¡¨ (Core Tables)
| è³‡æ–™è¡¨åç¨± | èªªæ˜ |
|----------|------|
| `users` | ä½¿ç”¨è€…è³‡æ–™ (å¸³è™Ÿã€å¯†ç¢¼ã€è§’è‰²) |
| `projects` | å°ˆæ¡ˆè³‡æ–™ (åç¨±ã€ç¾¤çµ„ã€ç‹€æ…‹) |
| `source_data` | åŸå§‹è³‡æ–™ (PDF URLã€é ç¢¼ã€å°ˆæ¡ˆé—œè¯) |
| `annotations` | æ¨™è¨»è³‡æ–™ (æ‰¿è«¾ã€è­‰æ“šã€ç‰ˆæœ¬æ§åˆ¶) â­ |

### ç¾¤çµ„æ¬Šé™ç³»çµ± (Group & Permissions)
| è³‡æ–™è¡¨åç¨± | èªªæ˜ |
|----------|------|
| `project_groups` | å°ˆæ¡ˆç¾¤çµ„ (ç¾¤çµ„åç¨±ã€æè¿°) |
| `user_group_permissions` | ä½¿ç”¨è€…-ç¾¤çµ„æ¬Šé™å°æ‡‰ |

### å…¬å¸è³‡æ–™ç®¡ç† (Company Management)
| è³‡æ–™è¡¨åç¨± | èªªæ˜ |
|----------|------|
| `companies` | å…¬å¸è³‡æ–™ (åç¨±ã€å¹´åº¦ã€å ±å‘Šé¡å‹) |
| `company_data_assignments` | å…¬å¸è³‡æ–™èˆ‡å°ˆæ¡ˆçš„åˆ†é…é—œä¿‚ |

### é‡æ¨™è¨»ç³»çµ± (Reannotation System)
| è³‡æ–™è¡¨åç¨± | èªªæ˜ |
|----------|------|
| `reannotation_rounds` | é‡æ¨™è¨»è¼ªæ¬¡è¨˜éŒ„ |
| `reannotation_tasks` | é‡æ¨™è¨»ä»»å‹™åˆ†é… |
| `agreement_scores_cache` | ä¸€è‡´æ€§åˆ†æ•¸å¿«å– (Krippendorff's Alpha) |
| `reannotation_audit_log` | æ¨™è¨»è®Šæ›´å¯©è¨ˆæ—¥èªŒ |

### å…¶ä»–åŠŸèƒ½ (Others)
| è³‡æ–™è¡¨åç¨± | èªªæ˜ |
|----------|------|
| `announcements` | ç³»çµ±å…¬å‘Š |

### é‡è¦æ¬„ä½èªªæ˜

#### `annotations` è¡¨ (æ¨™è¨»è³‡æ–™)
- **ç‰ˆæœ¬æ§åˆ¶æ¬„ä½**:
  - `reannotation_round`: æ¨™è¨»æ˜¯åœ¨ç¬¬å¹¾è¼ªç”¢ç”Ÿ (0 = åˆå§‹æ¨™è¨»)
  - `version`: åŒä¸€è¼ªå…§çš„ç‰ˆæœ¬è™Ÿ (æ¯æ¬¡ä¿®æ”¹ +1)
  - `persist_answer`: ä½¿ç”¨è€…æ˜¯å¦å …æŒæ­¤ç­”æ¡ˆ
  - `reannotation_comment`: é‡æ¨™è¨»å‚™è¨»

- **é‡æ¨™è¨»æ¶æ§‹**:
  - âœ… **ä¸è¦†è“‹åŸå§‹è³‡æ–™**: æ¯æ¬¡é‡æ¨™è¨»æœƒæ’å…¥æ–°è¨˜éŒ„ï¼Œè€Œéæ›´æ–°èˆŠè¨˜éŒ„
  - âœ… **å®Œæ•´æ­·å²è¿½è¹¤**: æ‰€æœ‰ç‰ˆæœ¬éƒ½ä¿ç•™åœ¨è³‡æ–™åº«ä¸­
  - âœ… **æŸ¥è©¢æœ€æ–°ç‰ˆæœ¬**: ä½¿ç”¨ `DISTINCT ON (source_data_id, user_id) ORDER BY version DESC` å–å¾—æœ€æ–°æ¨™è¨»

### è³‡æ–™åº«é·ç§» (Migrations)
```bash
# å»ºç«‹ skipped æ¬„ä½
npm run migrate:skipped

# å»ºç«‹é‡æ¨™è¨»åŠŸèƒ½è³‡æ–™è¡¨ï¼ˆ4 å¼µæ–°è¡¨ + annotations æ–°æ¬„ä½ï¼‰
npm run migrate:reannotation
```

---

## ğŸ“‚ ç›®å‰å°ˆæ¡ˆæ¶æ§‹
```
esg-annotator-app
â”œâ”€ ğŸ“.next
â”œâ”€ ğŸ“.claude
â”œâ”€ ğŸ“app
â”‚  â”œâ”€ ğŸ“admin
â”‚  â”‚  â”œâ”€ ğŸ“agreement             (ä¸€è‡´æ€§åˆ†æ)
â”‚  â”‚  â”‚  â””â”€ ğŸ“„page.js
â”‚  â”‚  â”œâ”€ ğŸ“reannotation          (é‡æ¨™è¨»ç®¡ç†)
â”‚  â”‚  â”‚  â””â”€ ğŸ“„page.js
â”‚  â”‚  â””â”€ ğŸ“„page.js               (ç®¡ç†å¾Œå°é¦–é )
â”‚  â”œâ”€ ğŸ“api
â”‚  â”‚  â”œâ”€ ğŸ“reannotation
â”‚  â”‚  â”‚  â”œâ”€ ğŸ“create-round       (å»ºç«‹é‡æ¨™è¨»è¼ªæ¬¡)
â”‚  â”‚  â”‚  â”‚  â””â”€ ğŸ“„route.js
â”‚  â”‚  â”‚  â”œâ”€ ğŸ“queue              (å–å¾—ä»»å‹™æ¸…å–®)
â”‚  â”‚  â”‚  â”‚  â””â”€ ğŸ“„route.js
â”‚  â”‚  â”‚  â””â”€ ğŸ“submit             (é€å‡ºé‡æ¨™è¨»)
â”‚  â”‚  â”‚     â””â”€ ğŸ“„route.js
â”‚  â”‚  â”œâ”€ ğŸ“calculate-agreement   (è¨ˆç®— Krippendorff's Alpha)
â”‚  â”‚  â”‚  â””â”€ ğŸ“„route.js
â”‚  â”‚  â””â”€ ğŸ“upload
â”‚  â”‚     â””â”€ ğŸ“„route.js
â”‚  â”œâ”€ ğŸ“reannotation
â”‚  â”‚  â”œâ”€ ğŸ“[taskId]              (é‡æ¨™è¨»è©³ç´°é é¢)
â”‚  â”‚  â”‚  â””â”€ ğŸ“„page.js
â”‚  â”‚  â””â”€ ğŸ“„page.js               (é‡æ¨™è¨»ä»»å‹™åˆ—è¡¨)
â”‚  â”œâ”€ ğŸ“„actions.js
â”‚  â”œâ”€ ğŸ“„adminActions.js
â”‚  â”œâ”€ ğŸ“„favicon.ico
â”‚  â”œâ”€ ğŸ“„globals.css
â”‚  â”œâ”€ ğŸ“„layout.js
â”‚  â”œâ”€ ğŸ“„page.js
â”‚  â””â”€ ğŸ“„page.module.css
â”œâ”€ ğŸ“components
â”‚  â””â”€ ğŸ“„PDFViewer.js
â”œâ”€ ğŸ“docs
â”‚  â”œâ”€ ğŸ“„batch-upload-guide.md
â”‚  â”œâ”€ ğŸ“„company-data-management-guide.md
â”‚  â””â”€ ğŸ“„reannotation-guide.md    â­ é‡æ¨™è¨»åŠŸèƒ½å®Œæ•´æŒ‡å—
â”œâ”€ ğŸ“public
â”‚  â”œâ”€ ğŸ“„file.svg
â”‚  â”œâ”€ ğŸ“„globe.svg
â”‚  â”œâ”€ ğŸ“„next.svg
â”‚  â”œâ”€ ğŸ“„pdf.worker.min.mjs
â”‚  â”œâ”€ ğŸ“„vercel.svg
â”‚  â””â”€ ğŸ“„window.svg
â”œâ”€ ğŸ“scripts
â”‚  â”œâ”€ ğŸ“„add-reannotation-feature.sql  (é‡æ¨™è¨» DB é·ç§»)
â”‚  â”œâ”€ ğŸ“„delete_all_blobs.js
â”‚  â”œâ”€ ğŸ“„delete_bold.js
â”‚  â””â”€ ğŸ“„upload.js
â”œâ”€ ğŸ“„.gitignore
â”œâ”€ ğŸ“„eslint.config.mjs
â”œâ”€ ğŸ“„jsconfig.json
â”œâ”€ ğŸ“„next.config.mjs
â”œâ”€ ğŸ“„package-lock.json
â”œâ”€ ğŸ“„package.json
â””â”€ ğŸ“„README.md
```

---

## ğŸ“š åƒè€ƒæ–‡ä»¶
è©³ç´°åŠŸèƒ½æ“ä½œè«‹åƒé–± docs/ è³‡æ–™å¤¾ï¼š
* [æ‰¹æ¬¡ä¸Šå‚³æŒ‡å—](docs/batch-upload-guide.md)
* [å…¬å¸è³‡æ–™ç®¡ç†æŒ‡å—](docs/company-data-management-guide.md)
* [ğŸ”„ é‡æ¨™è¨»åŠŸèƒ½ä½¿ç”¨æŒ‡å—](docs/reannotation-guide.md) â­ **NEW**

---

## ğŸ”„ é‡æ¨™è¨»åŠŸèƒ½äº®é»

### æ ¸å¿ƒç‰¹è‰²
- âœ… **æ™ºæ…§åˆ†é…ç­–ç•¥**ï¼šå°‘æ•¸æ´¾åŸå‰‡ - 2:1 æ™‚åªåˆ†é…çµ¦å°‘æ•¸æ´¾ï¼Œ1:1:1 æ™‚å…¨å“¡é‡æª¢
- âœ… **æ–¹æ¡ˆ A è¨­è¨ˆ**ï¼šé¡¯ç¤ºçµ±è¨ˆè³‡è¨Š + æ¨™è¨»æŒ‡å¼•ï¼ˆä¸é¡¯ç¤ºä»–äººé€ç­†ç­”æ¡ˆï¼‰
- âœ… **ä»»å‹™åˆ†çµ„**ï¼šåˆ†ç‚º Group 1 (æ‰¿è«¾+æ™‚é–“) å’Œ Group 2 (è­‰æ“š) é¿å…æ··äº‚
- âœ… **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ¯æ¬¡é‡æ¨™è¨»æ’å…¥æ–°è¨˜éŒ„ï¼Œå®Œæ•´ä¿ç•™æ­·å²ç‰ˆæœ¬
- âœ… **å¯©è¨ˆæ—¥èªŒ**ï¼šå®Œæ•´è¿½è¹¤æ‰€æœ‰è®Šæ›´æ­·ç¨‹
- âœ… **å …æŒç­”æ¡ˆæ©Ÿåˆ¶**ï¼šå…è¨±æ¨™è¨»è€…å …æŒè‡ªå·±çš„åˆ¤æ–·

### æ™ºæ…§åˆ†é…ç¯„ä¾‹
**æƒ…æ³ 1: æœ‰æ˜ç¢ºå°‘æ•¸æ´¾ (2:1)**
- A=Yes, B=Yes, C=No â†’ åªåˆ†é…çµ¦ C

**æƒ…æ³ 2: ä¸‰å€‹äººéƒ½ä¸ä¸€æ¨£ (1:1:1)**
- A=Yes, B=No, C=Unclear â†’ åˆ†é…çµ¦ Aã€Bã€C å…¨éƒ¨

**æƒ…æ³ 3: å¤šä»»å‹™æ··åˆ**
- promise_status: A=Yes, B=Yes, C=No â†’ C æ˜¯å°‘æ•¸æ´¾
- verification_timeline: A=within_2_years, B=within_2_years, C=within_2_years â†’ ä¸€è‡´
- **çµæœ**: åªåˆ†é…çµ¦ C

**æƒ…æ³ 4: æœ‰ä»»å‹™ä¸‰äººéƒ½ä¸åŒ**
- promise_status: A=Yes, B=Yes, C=No â†’ C æ˜¯å°‘æ•¸æ´¾
- verification_timeline: A=within_2_years, B=more_than_2_years, C=Unclear â†’ ä¸‰äººéƒ½ä¸åŒ
- **çµæœ**: åˆ†é…çµ¦ Aã€Bã€C å…¨éƒ¨ï¼ˆå› ç‚ºæœ‰ä¸€å€‹ä»»å‹™ä¸‰äººéƒ½ä¸åŒï¼‰

### å¿«é€Ÿé–‹å§‹
```bash
# 1. åŸ·è¡Œè³‡æ–™åº«é·ç§»
npm run migrate:reannotation

# 2. ç®¡ç†å“¡å‰å¾€ /admin/reannotation å»ºç«‹è¼ªæ¬¡
# 3. æ¨™è¨»è€…å‰å¾€ /reannotation è™•ç†ä»»å‹™
```

è©³ç´°èªªæ˜è«‹åƒè€ƒ [é‡æ¨™è¨»åŠŸèƒ½ä½¿ç”¨æŒ‡å—](docs/reannotation-guide.md)ã€‚
