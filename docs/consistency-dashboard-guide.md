# 標註一致性分析儀表板使用指南

## 📋 功能概述

標註一致性分析儀表板是一個強大的批次分析工具，能夠自動分析所有專案（包括初次標註和重標註資料）的標註一致性，並提供以下核心功能：

### 🎯 核心功能

1. **智能批次分析**
   - 一鍵分析所有已完成的專案和重標註輪次
   - 自動識別新專案和重標註資料，只計算尚未分析的內容
   - 使用快取機制（`agreement_scores_cache` 表）避免重複計算
   - 支援強制重新分析全部資料

2. **多維度篩選**
   - **組別篩選**：按專案組別（組1、組2、組3...）篩選
   - **標註類型篩選**：區分初次標註與重標註資料
   - **週次篩選**：按週數（第一週、第二週、第三週...）篩選

3. **完整資料匯出**
   - 匯出為 Excel 格式（.xlsx）
   - 按組別自動分 sheet
   - 包含所有標註細節和一致性分數
   - 附帶統計摘要 sheet

## 🚀 使用方式

### 1. 進入儀表板

從管理後台點擊 **「📊 一致性儀表板」** 按鈕進入。

### 2. 執行分析

#### 智能分析（推薦）
點擊 **「🚀 執行智能分析（僅新資料）」** 按鈕：
- 自動檢查 `agreement_scores_cache` 表
- 只計算尚未分析的專案和重標註輪次
- 已分析的資料直接從快取讀取
- 速度快，適合日常使用

#### 強制重新分析
點擊 **「🔄 重新分析全部」** 按鈕：
- 忽略快取，重新計算所有專案
- 更新所有快取資料
- 適合：快取資料不準確時、或資料庫更新後需要重新計算

### 3. 篩選資料

分析完成後，使用三個篩選器：

1. **組別**：選擇要查看的專案組別
   - 全部組別
   - 組1_非資訊相關大學生
   - 組2_非資訊相關學士生
   - 組3_資訊相關大學生
   - ...等

2. **標註類型**：
   - 全部類型
   - 初次標註（reannotation_round = 0）
   - 重標註（來自 reannotation_rounds 表）

3. **週次**：
   - 全部週次
   - 第 1 週（專案名稱沒有「第X周進度」）
   - 第 2 週（專案名稱包含「第二周進度」）
   - 第 3 週（專案名稱包含「第三周進度」）
   - ...等

### 4. 查看統計摘要

儀表板會顯示：
- **初次標註專案數**：初次標註的專案總數
- **重標註輪次數**：重標註的輪次總數
- **新分析數量**：本次新計算的項目數（綠色）
- **使用快取**：從快取讀取的項目數（橙色）

以及篩選範圍內的**整體一致性**（4 個任務的平均分數）：
- 承諾狀態 (promise_status)
- 驗證時間 (verification_timeline)
- 證據狀態 (evidence_status)
- 證據品質 (evidence_quality)

### 5. 匯出完整 Excel

點擊 **「📥 匯出完整 Excel」** 按鈕：

#### Excel 檔案結構

**按組別分 sheet：**
- Sheet 1: 組1_非資訊相關大學生
- Sheet 2: 組2_非資訊相關學士生
- Sheet 3: 組3_資訊相關大學生
- ...
- 最後一個 Sheet: 統計摘要

#### 每個組別 Sheet 包含的欄位：

| 欄位名稱 | 說明 |
|---------|------|
| 組別 | 專案所屬組別 |
| 專案名稱 | 完整專案名稱 |
| 週數 | 第幾週（從專案名稱解析） |
| 標註類型 | 初次標註 或 重標註第X輪 |
| 任務組別 | group1（承諾+時間）或 group2（證據） |
| 資料ID | source_data_id |
| 原始文本 | 永續承諾文本 |
| 承諾狀態分數 | promise_status 的 local alpha 分數 |
| 驗證時間分數 | verification_timeline 的 local alpha 分數 |
| 證據狀態分數 | evidence_status 的 local alpha 分數 |
| 證據品質分數 | evidence_quality 的 local alpha 分數 |
| 標註者1_名稱 | 第一位標註者姓名 |
| 標註者1_承諾狀態 | 第一位標註者的答案 |
| 標註者1_驗證時間 | ... |
| 標註者1_證據狀態 | ... |
| 標註者1_證據品質 | ... |
| 標註者2_... | 第二位標註者的答案 |
| 標註者3_... | 第三位標註者的答案 |
| 計算時間 | 一致性分數計算時間 |

#### 統計摘要 Sheet 包含：

| 欄位名稱 | 說明 |
|---------|------|
| 組別 | 組別名稱 |
| 初次標註專案數 | 該組的初次標註專案數量 |
| 重標註輪次數 | 該組的重標註輪次數量 |
| 總資料筆數 | 該組所有資料項總數 |
| 最後更新時間 | 該組最後一次計算的時間 |

## 🔧 技術細節

### 週數識別邏輯

週數從專案名稱中自動解析：
- 專案名稱包含「第二周進度」→ 第 2 週
- 專案名稱包含「第三周進度」→ 第 3 週
- 專案名稱沒有「第X周進度」→ 第 1 週

支援中文數字：一、二、三、四、五、六、七、八、九、十

### 重標註資料識別

使用 `reannotation_rounds` 表識別重標註資料：
- 從 `reannotation_rounds` 表取得所有 `status = 'completed'` 的輪次
- 每個輪次至少要有 2 位使用者完成（`reannotation_tasks` 表中 `status = 'submitted'`）
- 根據 `round_number` 和 `task_group` 區分不同的重標註輪次

### 快取機制

使用 `agreement_scores_cache` 表儲存已計算的分數：

```sql
CREATE TABLE agreement_scores_cache (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL,
    source_data_id INTEGER NOT NULL,
    round_number INTEGER DEFAULT 0,
    task_name TEXT NOT NULL,
    local_score NUMERIC(5,3),
    annotators_count INTEGER,
    calculated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(project_id, source_data_id, round_number, task_name)
);
```

**快取邏輯：**
1. 執行分析前，檢查 `(project_id, round_number)` 是否已有快取
2. 如果有快取，直接讀取 `local_score`
3. 如果沒有快取或使用「強制重新分析」，計算新的分數並儲存

### API 端點

**POST /api/batch-calculate-agreement**

請求參數：
```json
{
  "userId": 1,
  "force": false  // true = 強制重新分析，false = 智能分析
}
```

回應格式：
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "projectId": 1,
        "projectName": "組1_非資訊相關大學生_金融產業_mega_2886",
        "groupId": 1,
        "groupName": "組1_非資訊相關大學生",
        "roundNumber": 0,
        "roundType": "initial",
        "week": 1,
        "fromCache": false,
        "calculatedAt": "2026-01-04T12:00:00Z",
        "globalResults": [...],
        "detailedResults": [...],
        "annotatorCount": 3
      }
    ],
    "summary": {
      "totalProjects": 10,
      "totalReannotations": 5,
      "newAnalysis": 8,
      "fromCache": 7,
      "totalResults": 15
    }
  }
}
```

## 📊 分數解讀

### Krippendorff's Alpha 分數範圍

| 分數範圍 | 品質等級 | 顏色 | 說明 |
|---------|---------|------|------|
| α ≥ 0.800 | High | 綠色 | 高度一致，標註品質優良 |
| 0.500 ≤ α < 0.800 | Medium | 橙色 | 中等一致，可接受 |
| α < 0.500 | Low | 紅色 | 低一致性，建議重標註 |

### 分數類型

1. **Global Alpha（全域分數）**：
   - 每個任務（promise_status、verification_timeline...）的整體一致性
   - 所有資料項的平均

2. **Local Alpha（局部分數）**：
   - 每個資料項（source_data）在特定任務上的一致性
   - 用於識別哪些具體資料存在爭議

## 🎯 使用場景

### 場景 1: 每週進度檢查
1. 執行「智能分析」
2. 篩選「週次 = 第 2 週」
3. 查看該週的整體一致性
4. 匯出該週資料進行詳細分析

### 場景 2: 組別比較
1. 執行「智能分析」
2. 分別篩選不同組別
3. 比較各組的一致性表現
4. 匯出 Excel 後使用統計摘要 sheet 進行比較

### 場景 3: 重標註效果評估
1. 執行「智能分析」
2. 篩選「標註類型 = 重標註」
3. 查看重標註後的一致性是否提升
4. 匯出資料比對初次標註與重標註的差異

### 場景 4: 全面品質報告
1. 執行「智能分析」
2. 不使用任何篩選（查看全部）
3. 匯出完整 Excel
4. 使用 Excel 進行進一步的數據分析和視覺化

## ⚠️ 注意事項

1. **分析時間**：
   - 首次執行需要計算所有專案，可能需要較長時間
   - 後續執行只計算新資料，速度較快

2. **記憶體使用**：
   - 資料量大時，建議分批匯出（使用篩選器）
   - Excel 檔案大小受限於資料量

3. **快取更新**：
   - 如果標註資料有更新，需要使用「強制重新分析」
   - 快取資料不會自動更新

4. **權限要求**：
   - 只有管理員（admin role）可以使用此功能

## 🔄 與其他功能的整合

### 與「標註一致性分析」的差異

| 功能 | 標註一致性分析 | 一致性儀表板 |
|-----|---------------|-------------|
| 分析範圍 | 單一專案 | 所有專案批次分析 |
| 重標註支援 | 需手動選擇 | 自動包含 |
| 快取機制 | 無 | 有（智能分析） |
| 篩選功能 | 基本篩選 | 多維度篩選 |
| 匯出格式 | CSV（2個檔案） | Excel（多個 sheet） |
| 適用場景 | 深入分析單一專案 | 整體進度追蹤 |

### 與「重標註管理」的整合

儀表板會自動讀取 `reannotation_rounds` 表的資料，並計算每個重標註輪次的一致性。

## 📁 檔案位置

- **儀表板頁面**：`app/admin/consistency-dashboard/page.js`
- **API 路由**：`app/api/batch-calculate-agreement/route.js`
- **文檔**：`docs/consistency-dashboard-guide.md`

## 🐛 常見問題

### Q1: 為什麼沒有顯示某個專案？
**A**: 專案必須至少有 2 位使用者完成所有標註（status = 'submitted'）才會出現在分析中。

### Q2: 週數識別不正確怎麼辦？
**A**: 檢查專案名稱是否包含「第X周進度」格式，支援的中文數字為一到十。

### Q3: 快取資料不準確怎麼辦？
**A**: 使用「強制重新分析全部」按鈕清除並重建快取。

### Q4: Excel 匯出失敗怎麼辦？
**A**:
- 檢查瀏覽器是否允許下載
- 資料量過大時，使用篩選器縮小範圍
- 確認已安裝 xlsx 套件（`npm install xlsx`）

### Q5: 某些分數顯示 N/A 是什麼意思？
**A**:
- 該任務沒有足夠的標註資料（少於 2 位標註者）
- 或該任務在該輪次中不被計算（例如 group2 不計算 promise_status）

## 📈 未來優化方向

1. **即時更新**：WebSocket 實時推送分析進度
2. **圖表視覺化**：整合 Chart.js 顯示趨勢圖
3. **自訂匯出範圍**：支援自訂日期範圍、分數範圍等
4. **排程分析**：定時自動執行分析並發送報告
5. **異常檢測**：自動標記異常低的一致性分數

---

**版本**：1.0.0
**最後更新**：2026-01-04
**作者**：ESG Annotator Development Team
