# 公司資料分配管理功能使用指南

## 功能概述

這個功能允許管理員將公司的資料分段分配到不同的專案中，實現靈活的資料分配策略。

### 使用場景

例如：
- A公司有 100 筆資料
- 可以將 1-50 筆分配給專案 X
- 將 51-100 筆分配給專案 Y
- 系統會自動防止重複分配

## 使用步驟

### 第一次使用

1. **執行資料庫遷移**
   - 點擊「開啟公司資料管理」
   - 點擊「執行公司管理資料庫遷移」
   - 這會建立必要的資料表

2. **掃描現有專案**
   - 點擊「掃描專案並建立公司記錄」
   - 系統會自動從現有專案中提取公司資訊

### 日常使用

#### 分配資料流程

1. **選擇公司**
   - 從下拉選單選擇要分配的公司
   - 系統會顯示總資料筆數、已分配筆數和剩餘筆數

2. **查看可用範圍**
   - 系統會自動顯示尚未分配的資料範圍
   - 以藍色標籤顯示，例如「1-100 (100筆)」

3. **設定分配範圍**
   - 輸入起始記錄編號（例如：1）
   - 輸入結束記錄編號（例如：50）
   - 系統會顯示總共要分配的筆數

4. **選擇目標專案**
   - 從下拉選單選擇要接收資料的專案
   - 可以看到專案所屬的群組

5. **執行分配**
   - 點擊「分配資料到專案」
   - 確認分配資訊
   - 等待系統完成分配

#### 查看分配歷史

選擇公司後，會在下方顯示「分配歷史」表格，包含：
- 目標專案名稱
- 資料範圍（起始-結束）
- 記錄數量
- 分配時間
- 撤銷按鈕

#### 撤銷分配

如果需要撤銷某個分配：
1. 在分配歷史中找到要撤銷的記錄
2. 點擊「撤銷」按鈕
3. 確認操作
4. 該範圍的資料會重新變為可用狀態

## 防重複機制

系統內建多重防護：
1. **資料庫約束**：同一範圍不能重複分配
2. **範圍檢測**：系統會自動檢測重疊範圍並阻止分配
3. **可用範圍提示**：只顯示尚未分配的範圍供選擇

如果嘗試分配已使用的範圍，系統會顯示錯誤訊息並列出重疊的範圍。

## 實際案例

### 案例 1：將公司資料分配給不同標註者

**背景**：
- 富邦金控有 150 筆 ESG 資料
- 需要分給 3 個標註團隊

**操作**：
1. 選擇「富邦金控」
2. 分配 1-50 給「專案A」（團隊1）
3. 分配 51-100 給「專案B」（團隊2）
4. 分配 101-150 給「專案C」（團隊3）

### 案例 2：調整分配比例

**背景**：
- 發現團隊1進度較快，需要更多資料
- 團隊2進度較慢，想減少負擔

**操作**：
1. 撤銷團隊2的分配（51-100）
2. 重新分配 51-80 給團隊2（30筆）
3. 分配 81-100 給團隊1（20筆）

## 技術細節

### 資料表結構

#### companies 表
儲存公司基本資訊：
- 公司代碼
- 公司名稱
- 所屬組別
- 總記錄數
- 已分配記錄數

#### company_data_assignments 表
儲存分配記錄：
- 公司ID
- 專案ID
- 起始記錄
- 結束記錄
- 記錄數量
- 分配時間

### API 函數

- `scanAndCreateCompanyRecords()` - 掃描專案建立公司記錄
- `getAllCompanies()` - 取得所有公司列表
- `assignCompanyDataToProject()` - 執行資料分配
- `getCompanyAssignmentDetails()` - 查詢分配歷史
- `removeCompanyDataAssignment()` - 撤銷分配
- `getAvailableRanges()` - 取得可用範圍

## 注意事項

1. **記錄編號從 1 開始**：資料範圍使用 1-based 索引
2. **範圍包含結束值**：1-50 表示包含第 50 筆資料
3. **撤銷不會刪除標註**：撤銷只是解除分配關係，不會刪除已完成的標註
4. **先掃描再分配**：確保先執行掃描建立公司記錄後再進行分配
5. **定期重新掃描**：新增專案後建議重新掃描以更新資料

## 疑難排解

### Q: 公司列表是空的？
A: 請先點擊「掃描專案並建立公司記錄」

### Q: 分配失敗顯示「資料範圍重疊」？
A: 檢查分配歷史，確認該範圍沒有被分配過，或先撤銷舊的分配

### Q: 可用範圍顯示為空？
A: 表示該公司的所有資料已全部分配完畢

### Q: 如何重新分配？
A: 先撤銷現有分配，然後重新選擇範圍分配

## 未來擴展

可能的功能增強：
- 批次分配多家公司
- 自動平均分配
- 分配策略模板
- 分配進度視覺化
- 匯出分配報表
